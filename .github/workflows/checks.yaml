name: Checks

on:
  push:
    branches-ignore:
      - master

env:
  npm_config_cache: .cache/npm

jobs:
    commit_lint:
      name: Lint commit messages
      runs-on: ubuntu-latest
      steps:
        - name: Check out code
          uses: actions/checkout@v2
          with:
            fetch-depth: 0

        - name: Lint commit messages
          uses: wagoid/commitlint-github-action@v1
          with:
            failOnWarnings: true

    # Always lint
    lint_and_test:
        name: Linting and tests
        runs-on: ubuntu-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v2

        - name: Use Node.js 12.x
          uses: actions/setup-node@v1
          with:
            node-version: 12.x
        
        - name: Configure npm cache
          uses: actions/cache@v1
          with:
            path: ${{ env.npm_config_cache }}
            key: npm-${{ hashFiles('./package*.json') }}

        - name: Install dependencies
          run: npm install

        - name: Run linter
          run: npm run lint

        - name: Run unit tests
          run: npm run test

    docs:
      name: Generate docs
      runs-on: ubuntu-latest
      needs: [lint_and_test]

      steps:
        - name: Checkout code
          uses: actions/checkout@v2

        - name: Use Node.js 12.x
          uses: actions/setup-node@v1
          with:
            node-version: '12.x'

        - name: Configure npm cache
          uses: actions/cache@v1
          with:
            path: ${{ env.npm_config_cache }}
            key: npm-${{ hashFiles('./package*.json') }}

        - name: Install dependencies
          run: npm install

        - name: Generate docs
          run: npm run docs

        - name: Commit docs
          uses: stefanzweifel/git-auto-commit-action@v4.1.2
          with:
            commit_message: "docs: auto-gen documentation"
            commit_user_name: "Otto the Bot"
            commit_user_email: otc-builder@outcome.co
            commit_author: "Otto the Bot <otc-builder@outcome.co>"
